# ComfyUI Prompt Extractor

Extracts the **final positive prompt** from PNG images generated by [ComfyUI](https://github.com/comfyanonymous/ComfyUI).  
Works even if your workflow uses `ShowText`, direct `CLIPTextEncode` inputs, or more complex string chains — it analyzes the workflow graph stored in the PNG metadata and follows the path into the **last `CLIPTextEncode` node that feeds the `positive` input** of the sampler that created the saved image.

---

## Features

- ✅ Works with **any workflow** (not limited to `ShowText|pysssss` nodes).  
- ✅ Finds the **exact prompt** that was actually used in sampling.  
- ✅ Handles direct text in `CLIPTextEncode` or linked string nodes.  
- ✅ Outputs to plain text (`.txt`) or CSV (`.csv`).  
- ✅ Defaults to current folder for input and output.  
- ✅ Tested on Windows 11 with Python 3.10+.  

---

## Installation

1. Clone this repo or download the script:
   ```bash
   git clone https://github.com/yourusername/comfyui-prompt-extractor.git
   cd comfyui-prompt-extractor
```

2. Install requirements:

   ```bash
   pip install pillow
   ```

---

## Usage

### Basic (text output, one prompt per line)

```bash
python extract_prompts.py
```

* Scans the current folder (`.`) for `.png` images.
* Writes `prompts.txt` with one flattened prompt per line.

---

### CSV output

```bash
python extract_prompts.py --csv
```

* Scans the current folder.
* Writes `prompts.csv` with `filename,prompt` columns.
* Prompts are quoted, so commas or newlines are preserved.

---

### Custom folder

```bash
python extract_prompts.py "C:\path\to\images"
```

* Scans that folder for `.png` images.
* Outputs to `prompts.txt` (or `prompts.csv` if `--csv` is used).

---

### Custom folder + custom output file

```bash
python extract_prompts.py "C:\path\to\images" "C:\output\my_prompts.txt"
python extract_prompts.py "C:\path\to\images" "C:\output\my_prompts.csv" --csv
```

---

## Output examples

### prompts.txt

```
Candid photograph. A low-angle close-up captures an elderly woman’s face centered in a sunlit coffee shop...
A futuristic city skyline at dusk, neon reflections glowing on glass towers...
```

### prompts.csv

```csv
filename,prompt
image_001.png,"Candid photograph. A low-angle close-up captures an elderly woman’s face centered in a sunlit coffee shop..."
image_002.png,"A futuristic city skyline at dusk, neon reflections glowing on glass towers..."
```

---

## Notes

* If a PNG has no ComfyUI workflow metadata, it will be skipped.
* If multiple `SaveImage` nodes exist, the script uses the one with the **highest execution order** (most likely the one that produced the saved file).
* Prompts in `.txt` output are **flattened to a single line** for easier parsing.

---

## License

MIT License. See [LICENSE](LICENSE) for details.

```
